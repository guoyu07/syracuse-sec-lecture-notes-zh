# 五、竞态条件

> 原文：[Race Condition Vulnerability](http://www.cis.syr.edu/~wedu/Teaching/CompSec/LectureNotes_New/Race_Condition.pdf)

> 译者：[飞龙](https://github.com/wizardforcel)

## 1 竞态条件漏洞

+   下面的代码段属于某个特权程序（即 Set-UID 程序），它使用 Root 权限运行。

    ```c
    1: if (!access("/tmp/X", W_OK)) { 
    2: /* the real user ID has access right */ 
    3: f = open("/tmp/X", O_WRITE); 4
    : write_to_file(f); 
    5: } 
    6: else { 
    7: /* the real user ID does not have access right */ 
    8: fprintf(stderr, "Permission denied\n"); 
    9: }
    ```
    
    +   `access`系统该调用检查了真实 UID 或者 GID 是否拥有访问文件的权限，有的话返回 0。在代表真实 UID （而不是有效 UID）访问文件之前，该系统调用通常由 Set-UID 程序使用。
    +   `open`系统调用也执行访问控制，但是仅仅检查有效 UID 或 GID 是否拥有访问文件的权限。
    +   上面的程序想要写入文件`/tmp/X`。在这么做之前，它要确保，文件确实由真实 UID 写入。如果没有这种检查，程序可以写入这个文件，无论真实 UID 可不可以写入它，因为程序使用 Root 权限运行（即`open`所检查的有效 UID 是 Root）。
+   假设上面的程序执行的非常慢。执行程序中的每行语句需要一分钟。请思考下列问题：
    +   你可以使用这个程序来覆盖其它文件，例如`/etc/passwd`嘛？
    +   你不能修改该程序，但是你可以利用每两条语句之前的的一分钟。
    +   `/tmp`目录的权限为`rwxrwxrwx`，这允许任何用户在里面创建文件或链接。
    +   提示：`/tmp/X`不需要是真实文件，他可以是符号链接。
+   攻击策略：
    +   如果我们让`/tmp/X`在第一行之前打印`/etc/passwd`，`access`调用就会发现，真实 UID 没有权限来修改`/etc/passwd`。因此，执行流会来到`else`分支。在第一行之前，`/tmp/X`必须是一个能被真实 UID 写入的文件。
    +   显然，如果我们在第一行之后不做任何事情，`/tmp/X`会打开，攻击者不能获得任何东西。
    +   让我们专注于第一行和第三行之前的时间间隔。由于我们假设，程序执行得很慢。我们在第一行之后，第三行之前有一分钟的间隔。使用这个时间间隔，我们可以删掉`/tmp/X`并且使用相同名称创建符号链接。并使其指向`/etc/passwd`。
    +   如果我们这么做，会发生什么？
        +   通过遵循符号链接，程序使用`open`来打开` /etc/passwd`。
        +   `open`系统调用只检查有效 UID 或 GID 是否可以访问文件。由于这是个 Set-UID Root 程序，有效 UID 是 Root，它可以读写`/etc/passwd`。
        +   因此，第四行实际上会写入文件`/etc/passwd`。如果写入文件的内容也可以由用户控制，攻击者就可以修改密码文件，并且最终获得 Root 权限。如果内容不能由用户控制，攻击者可以破坏密码文件，组织其他用户登入系统。
+   回到现实：这个程序执行得很快，并且我们没有一分钟时间间隔。我们可以做什么？
+   竞态条件攻击
    +   使`/tmp/X`在访问和打开调用中，表现为两个文件。
    +   在`access(/tmp/X, W_OK)`之前，`/tmp/X`就是`/tmp/X`。
    +   在`access(/tmp/X, W_OK)`之后，将`/tmp/X`修改为`/etc/passwd`。
    +   如何实现？
        +   在两个调用之间只有很短的时间间隔。
        +   检查和使用之间的间隔：TOCTOU
        +   CPU 可能在`access`后进行上下文切换，之后执行其它进程。
        +   如果攻击进程在上下文切换之间，得到了机会来执行这种攻击，攻击就会成功。
        +   因为我们不能保证，第一行和第三行之间存在上下文切换，即使攻击程序在上下文切换期间，得到执行机会，攻击也可能失败。但是，如果执行一次不成功，我们可以多次执行攻击和目标程序。
+   提高成功率：竞态条件攻击的最关键步骤，出现在 TOCTOU 间隔中。由于我们不能修改漏洞程序，我们可以做的只有让我们的攻击程序和目标程序一起运行。并希望链接的时机正好就在间隔之内。不幸的是，我们不能完成完美的时间规划。因此，攻击是否成功是个概率。攻击成功的概率可能很低，如果间隔很小。我们如何提升概率呢？
    +   通过执行多个 CPU 密集的程序来拖慢计算机。
    +   创建多个攻击进程。
+   另一个例子（Set-UID 程序）：
    
    ```c
    file = "/tmp/X"; 
    fileExist = check_file_existence(file); 
    if (fileExist == FALSE){ 
        // The file does not exist, create it. 
        f = open(file, O_CREAT); 
    }
    ```
    
    +   在 Unix 中，我们使用`open`系统调用来创建文件。
    +   ` open(file, O_CREAT) `在文件不存在时创建文件，如果文件存在，它只会打开文件。
+   为什么存在漏洞？
    +   竞态条件：使文件在检查期间不存在，并使其在检查之后指向`/etc/passwd`。
